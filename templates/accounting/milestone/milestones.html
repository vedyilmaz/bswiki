{% extends "layout.html" %}
{% load humanize %}
{% load mathfilters %}
{% block body %}

    <div class="container-fluid">
        <div class="input-group mb-3">
          <div class="input-group-prepend">
              <form>
                  <h4>Milestones</h4>
                  <p>&nbsp;</p>
<!--                  <a class="btn btn-info" href ="{% url 'accounting:add_contract_sale' %}">Add Contract Sale</a>-->
                  <a class="btn btn-primary text-gray disabled" id="id_btn_invoice" onclick="getSelectedSales('cbSales')">Make Invoice</a>
<!--                {% csrf_token %}-->
<!--                <button class="btn btn-secondary" type="submit">Search</button>-->
          </div>
<!--                <input type="text" name="keyword" class="form-control" placeholder="Input a keyword to search for ..." aria-label="" aria-describedby="basic-addon1">-->
              </form>
        </div>

        <div class="input-group mb-3">
              <div class="input-group-prepend">
                  <form>
                    {% csrf_token %}
                    <button class="btn btn-secondary" type="submit">Search</button>
              </div>
                  <input type="text" name="keyword" class="form-control" placeholder="Input a keyword ..." aria-label="" aria-describedby="basic-addon1">
                </form>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="inlineCheckbox1" value="option1" checked />
            <label class="form-check-label" for="inlineCheckbox1">Hide invoiced sales</label>




    {% if not milestone_list %}
        <div class="alert alert-danger" style = "margin-top:20px;">There is no milestone yet.</div>

    {% else %}
        <table class="table table-hover" style="margin-top:20px;">
            <thead>
                <tr>
                    <th scope="col">id</th>
                    <th scope="col">Invoice</th>
                    <th scope="col">Contract Alias</th>
                    <th scope="col">Due Date</th>
                    <th scope="col">Delivery Date</th>
                    <th scope="col">Milestone Number</th>
                    <th scope="col">Milestone Amount</th>
                    <th scope="col">Currency</th>
                </tr>
            </thead>
            <tbody>
                {% for cs in milestone_list  %}
                    <tr>
                        <th scope="row">{{ cs.id }}</th>
                        {% if cs.is_completed %}
<!--                        <td><input class="form-check-input radioMileStone" style="vertical-align: middle; margin: 10px;" name="radio-milestone" type="radio" value="{{ cs.id }}" disabled></td>-->
                        <td><input class="form-check-input cbSales" type="checkbox"  style="vertical-align: middle; margin: 10px;" value="{{ cs.id }}" disabled/></td>
                        {% else %}
<!--                        <td><input class="form-check-input radioMileStone" style="vertical-align: middle; margin: 10px;" name="radio-milestone" type="radio" value="{{ cs.id }}"></td>-->
                        <td><input class="form-check-input cbSales" type="checkbox" style="vertical-align: middle; margin: 10px;" value="{{ cs.id }}"/></td>
                        {% endif %}
                        <td><a href="{% url 'accounting:contract_detail' cs.contract__id %}">{{ cs.contract__contract_alias }}</a></td>
                                    <!--/articles/article/{{ article.id }}-->
                        <td>{{ cs.due_date }}</td>
                        <td>{{ cs.delivery_date }}</td>
                        <td>{{ cs.milestone_number }}</td>
                        <td>{{ cs.milestone_amount }}</td>
                        <td>{{ cs.contract__currency }}</td>
                        <td><a href="{% url 'accounting:milestone_update' cs.id %}">Update</a></td>
                        <td><a class="confirm-delete" href="{% url 'accounting:delete_milestone' cs.id %}">Delete</a></td>
                    </tr>
                {% endfor %}

            </tbody>
            </div>
        </div>
        </table>

        <script>

    let sales_ids = [];
    $(document).on('click', '.confirm-delete', function(){
        return confirm('Are you sure you want to delete this?');
    })

    function getElement(elm){
        return document.getElementById(elm);
    }

    function removeClass(elm, class_name){
        var stat = elm.classList.contains(class_name);
        if (stat == true) {
            elm.classList.remove(class_name);
            console.log("class name removed:" + class_name);
        }
    }

    function addClass(elm, class_name){
        var stat = elm.classList.contains(class_name);
        if (stat == false) {
            elm.classList.add(class_name);
            console.log("class name removed:" + class_name);
        }
    }

    var matches = document.querySelectorAll('.cbSales');
    for (match in matches) {
      matches[match].onclick = function() {
        if (this.checked){
            console.log("checked!");
            sales_ids.push(this.value);
            console.log("sales id set!" + sales_ids);
        }else{
            console.log("unchecked!");
            sales_ids.pop(this.value);
            console.log("sales id removed");

        }
        console.log("sales ids: " + sales_ids);

        if (sales_ids.length == 0){
            disable_btn();
        }else{
            enable_btn();
        }
      }
    }

    function enable_btn(){
        var btn_invoice = getElement('id_btn_invoice');
        removeClass(id_btn_invoice, "disabled");
        removeClass(id_btn_invoice, "text-gray");
        addClass(id_btn_invoice, "text-white");
    }

    function disable_btn(){
        var btn_invoice = getElement('id_btn_invoice');
        addClass(id_btn_invoice, "disabled");
        addClass(id_btn_invoice, "text-gray");
        removeClass(id_btn_invoice, "text-white");
    }

    function set_invoice_data(){
        console.log("---setting invoice_data---");
        const url = "/accounting/set_invoice_data";
        console.log("url: " + url);
        console.log("sales id: " + sales_ids);
        $.ajax({                       // initialize an AJAX request
          url: url,                    // set the url of the request (= localhost:8000/accounting/set_invoice_data/)
          dataType: "json",
          method: "POST",
          data: {
            'csrfmiddlewaretoken': '{{ csrf_token }}',
            'sales_id': JSON.stringify(sales_ids),       // add the contract id to the GET parameters
          },
          success: function (data) {   // `data` is the return of the `load_contracts` view function
            console.log("data: " + data);
            window.location.href = "{% url 'accounting:add_cont_sale_invoice' %}"
    <!--        $("#id_rate_amount").html(data.rate_amount);-->
    <!--        $("#id_rate_amount").val(data.rate_amount);-->
          },
            error: function(e)
            {
                console.log('Error: ' + e);
                sales_ids = [];
            }
        });
  }
    function getSelectedSales(cbClassName) {
      var checkboxes = document.getElementsByClassName(cbClassName);
      var checkboxesChecked = [];
      for (var i=0; i<checkboxes.length; i++) {
         if (checkboxes[i].checked) {
            checkboxesChecked.push(checkboxes[i].value);
         }
      }
      console.log("checked boxes: " +checkboxesChecked);
      // console.log("type of checked boxes: " + typeof(checkboxesChecked));
      set_invoice_data();
      return checkboxesChecked.length > 0 ? checkboxesChecked : null;
    }

    </script>
        
    {% endif %}
{% endblock body %}